<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<title>Ng∆∞·ªùi G·ª≠i - G·ª≠i file b·∫£o m·∫≠t</title>
<!-- Tailwind CSS CDN -->
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  body {
    font-family: 'Inter', sans-serif;
    background-color: #f0f2f5; /* Light grey background */
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    margin: 0;
  }
  .fb-container {
    background-color: #fff;
    padding: 2rem; /* p-8 */
    border-radius: 1.5rem; /* rounded-3xl */
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.05); /* shadow-xl */
    max-width: 32rem; /* max-w-lg */
    width: 100%;
    text-align: center;
    border: 1px solid #e2e8f0; /* Subtle border */
  }
  .fb-header {
    font-size: 2.25rem; /* text-4xl */
    font-weight: 700; /* font-bold */
    color: #4f46e5; /* Deep purple */
    margin-bottom: 2rem; /* mb-8 */
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .fb-header::before {
    content: 'üéß'; /* Audio icon */
    margin-right: 12px;
    font-size: 1.2em;
  }
  .fb-key-input {
    width: 100%;
    padding: 0.75rem; /* p-3 */
    margin-bottom: 1.5rem; /* mb-6 */
    border-width: 1px; /* border */
    border-color: #d1d5db; /* border-gray-300 */
    border-radius: 0.5rem; /* rounded-lg */
    outline: none; /* focus:outline-none */
    box-shadow: 0 0 0 2px rgba(99, 102, 241, 0); /* focus:ring-2 focus:ring-indigo-500 (initially transparent) */
    transition: box-shadow 0.2s ease-in-out; /* Add transition for focus ring */
    color: #374151; /* text-gray-700 */
    font-size: 0.875rem; /* text-sm */
    min-height: 120px; /* More height for keys */
    resize: vertical; /* Allow vertical resizing */
  }
  .fb-key-input:focus {
    border-color: #6366f1; /* focus:border-indigo-500 */
    box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.5); /* focus:ring-2 focus:ring-indigo-500 */
  }
  .fb-form {
    margin-bottom: 1.5rem; /* mb-6 */
  }
  .fb-input-file {
    display: block;
    width: 100%;
    font-size: 0.875rem; /* text-sm */
    color: #6b7280; /* text-gray-500 */
    margin-bottom: 1.5rem; /* mb-6 */

    /* Styles for the file input button */
    --file-mr-4: 1rem;
    --file-py-2: 0.5rem;
    --file-px-4: 1rem;
    --file-rounded-full: 9999px;
    --file-border-0: 0px;
    --file-text-sm: 0.875rem;
    --file-font-semibold: 600;
    --file-bg-indigo-50: #eef2ff;
    --file-text-indigo-700: #4338ca;
    
    margin-right: var(--file-mr-4);
    padding-top: var(--file-py-2);
    padding-bottom: var(--file-py-2);
    padding-left: var(--file-px-4);
    padding-right: var(--file-px-4);
    border-radius: var(--file-rounded-full);
    border-width: var(--file-border-0);
    font-size: var(--file-text-sm);
    font-weight: var(--file-font-semibold);
    background-color: var(--file-bg-indigo-50);
    color: var(--file-text-indigo-700);
    cursor: pointer;
    transition: background-color 0.2s ease-in-out;
  }
  .fb-input-file:hover {
    --file-bg-indigo-100: #e0e7ff;
    background-color: var(--file-bg-indigo-100);
  }
  .fb-button {
    width: 100%;
    padding-left: 1.5rem; /* px-6 */
    padding-right: 1.5rem; /* px-6 */
    padding-top: 0.75rem; /* py-3 */
    padding-bottom: 0.75rem; /* py-3 */
    background-image: linear-gradient(to right, #6366f1, #9333ea); /* bg-gradient-to-r from-indigo-500 to-purple-600 */
    color: #fff; /* text-white */
    font-weight: 700; /* font-bold */
    border-radius: 9999px; /* rounded-full */
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
    outline: none; /* focus:outline-none */
    transition-property: all; /* transition */
    transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); /* ease-in-out */
    transition-duration: 300ms; /* duration-300 */
    transform: translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y)); /* transform */
    letter-spacing: 0.05em; /* Slightly more space for button text */
  }
  .fb-button:hover {
    background-image: linear-gradient(to right, #4f46e5, #7e22ce); /* hover:from-indigo-600 hover:to-purple-700 */
    transform: translateY(-4px); /* hover:-translate-y-1 */
  }
  .fb-button:focus {
    box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.5), 0 0 0 4px rgba(99, 102, 241, 0.25); /* focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75 */
  }

  /* Styles for the new socket status */
  .socket-status {
    margin-top: 1rem; /* mt-4 */
    font-size: 0.95rem; /* text-base */
    font-weight: 500; /* font-medium */
    color: #4b5563; /* text-gray-700 */
  }
  .socket-status.connected {
    color: #10b981; /* Green for connected */
  }
  .socket-status.disconnected {
    color: #ef4444; /* Red for disconnected */
  }
</style>
</head>
<body>
<div class="fb-container">
  <h1 class="fb-header">Ng∆∞·ªùi G·ª≠i</h1>
  <label class="block text-gray-700 text-sm font-bold mb-2 text-left" for="receiverKey">
    Kh√≥a c√¥ng khai ng∆∞·ªùi nh·∫≠n (PEM):
  </label>
  <textarea id="receiverKey" rows="6" class="fb-key-input" placeholder="D√°n kh√≥a c√¥ng khai c·ªßa ng∆∞·ªùi nh·∫≠n v√†o ƒë√¢y..."></textarea>
  
  <form id="uploadForm" enctype="multipart/form-data" class="fb-form">
    <label class="block text-gray-700 text-sm font-bold mb-2 text-left" for="file">
      Ch·ªçn file MP3:
    </label>
    <input type="file" name="file" accept=".mp3" required class="fb-input-file" id="file" />
    <button type="submit" class="fb-button">T·∫£i l√™n & B·∫Øt ƒë·∫ßu g·ª≠i</button>
  </form>
  <p id="status" class="fb-status"></p>
  <p id="socketStatus" class="socket-status">Tr·∫°ng th√°i k·∫øt n·ªëi Socket.IO: ƒêang ch·ªù...</p> <!-- New status element -->
</div>

<!-- ƒê√£ di chuy·ªÉn to√†n b·ªô kh·ªëi script xu·ªëng cu·ªëi body v√† b·ªçc trong DOMContentLoaded -->
<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script> <!-- Ensure this is here -->
<script>
  document.addEventListener('DOMContentLoaded', (event) => {
    const socket = io();
    const form = document.getElementById('uploadForm');
    const statusDiv = document.getElementById('status');
    const receiverKeyTextarea = document.getElementById('receiverKey');
    const socketStatusDiv = document.getElementById('socketStatus');

    let currentSocketId = null; // Bi·∫øn ƒë·ªÉ l∆∞u SID c·ªßa Socket.IO

    socket.on('connect', () => {
      socketStatusDiv.innerText = 'Tr·∫°ng th√°i k·∫øt n·ªëi Socket.IO: ‚úÖ ƒê√£ k·∫øt n·ªëi.';
      socketStatusDiv.classList.remove('disconnected');
      socketStatusDiv.classList.add('connected');
      currentSocketId = socket.id; // L·∫•y SID ngay khi k·∫øt n·ªëi
      console.log('DEBUG (Sender): SocketIO connected, SID:', currentSocketId);
      statusDiv.innerText = 'S·∫µn s√†ng ƒë·ªÉ t·∫£i file l√™n v√† b·∫Øt ƒë·∫ßu qu√° tr√¨nh m√£ h√≥a.';
    });

    socket.on('disconnect', () => {
      socketStatusDiv.innerText = 'Tr·∫°ng th√°i k·∫øt n·ªëi Socket.IO: üî¥ ƒê√£ ng·∫Øt k·∫øt n·ªëi.';
      socketStatusDiv.classList.remove('connected');
      socketStatusDiv.classList.add('disconnected');
      currentSocketId = null;
      statusDiv.innerText = 'Vui l√≤ng l√†m m·ªõi trang ƒë·ªÉ k·∫øt n·ªëi l·∫°i.';
    });

    form.onsubmit = async (e) => {
      e.preventDefault();
      const receiverPublicKey = receiverKeyTextarea.value.trim();
      
      console.log('DEBUG (Sender): Gi√° tr·ªã kh√≥a c√¥ng khai ng∆∞·ªùi nh·∫≠n t·ª´ textarea:', receiverPublicKey);

      if (!receiverPublicKey) {
        alert('Vui l√≤ng nh·∫≠p kh√≥a c√¥ng khai ng∆∞·ªùi nh·∫≠n!');
        return;
      }
      
      if (!currentSocketId) {
          alert('Ch∆∞a k·∫øt n·ªëi Socket.IO, vui l√≤ng ƒë·ª£i ho·∫∑c l√†m m·ªõi trang ƒë·ªÉ ƒë·∫£m b·∫£o k·∫øt n·ªëi.');
          return;
      }

      statusDiv.innerText = '‚è≥ ƒêang t·∫£i file l√™n...';

      const formData = new FormData(form);
      formData.append('receiver_public_key_pem', receiverPublicKey);
      formData.append('sender_socket_id', currentSocketId); // TH√äM D√íNG N√ÄY ƒê·ªÇ G·ª¨I SID

      try {
        const res = await fetch('/upload', {
          method: 'POST',
          body: formData
        });
        const text = await res.text();
        statusDiv.innerText = text;

        // B·∫Øt ƒë·∫ßu handshake
        // Ch·ªâ g·ª≠i handshake n·∫øu upload HTTP th√†nh c√¥ng
        if (res.ok) { // Ki·ªÉm tra xem HTTP response c√≥ th√†nh c√¥ng kh√¥ng (status 2xx)
            socket.emit('handshake', {msg: 'Hello!'});
            statusDiv.innerText = 'T·∫£i file th√†nh c√¥ng l√™n server. ƒêang ch·ªù handshake...';
        } else {
            statusDiv.innerText = `‚ùå T·∫£i file th·∫•t b·∫°i: ${text}`;
        }
        
      } catch (err) {
        statusDiv.innerText = '‚ùå L·ªói m·∫°ng khi t·∫£i file. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi server.';
        console.error("L·ªói t·∫£i file:", err);
      }
    };

    socket.on('handshake_reply', (data) => {
      if(data.msg === 'Ready!'){
        statusDiv.innerText = '‚úÖ Server ƒë√£ s·∫µn s√†ng. Ch·ªù ng∆∞·ªùi nh·∫≠n ph·∫£n h·ªìi...';
      }
    });

    socket.on('public_key_confirm', (data) => {
      if(data.status === 'ok'){
        statusDiv.innerText = 'üîë Ng∆∞·ªùi nh·∫≠n ƒë√£ x√°c nh·∫≠n kh√≥a. B·∫Øt ƒë·∫ßu g·ª≠i file...';
      } else {
        statusDiv.innerText = '‚ùå Ng∆∞·ªùi nh·∫≠n b√°o kh√≥a kh√¥ng h·ª£p l·ªá, d·ª´ng g·ª≠i.';
      }
    });

    socket.on('meta', (data) => {
      statusDiv.innerText = 'üìÑ ƒê√£ g·ª≠i metadata';
    });

    socket.on('key', (data) => {
      statusDiv.innerText = 'üîê ƒê√£ g·ª≠i kh√≥a phi√™n m√£ h√≥a';
    });

    socket.on('chunk', (data) => {
      statusDiv.innerText = `üì¶ ƒê√£ g·ª≠i ƒëo·∫°n ${data.index + 1}/3`;
    });

    socket.on('end', () => {
      statusDiv.innerText = 'üéâ G·ª≠i file th√†nh c√¥ng!';
    });

    socket.on('send_cancel', (data) => {
      statusDiv.innerText = `‚ùå G·ª≠i b·ªã h·ªßy: ${data.reason}`;
    });
  }); // End DOMContentLoaded listener
</script>
</body>
</html>
